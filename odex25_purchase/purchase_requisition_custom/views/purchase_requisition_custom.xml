<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- Inherit the Purchase Requisition form and adding buttons to header tag -->
        <record id="purchase_requisition_custom_form_view" model="ir.ui.view">
            <field name="name">purchase.requisition.form.custom</field>
            <field name="model">purchase.requisition</field>
            <field name="inherit_id" ref="purchase_requisition.view_purchase_requisition_form"/>
            <field name="arch" type="xml">

                <xpath expr="//form" position="attributes">
                    <attribute name="delete">0</attribute>
                </xpath>
                <xpath expr="//div[@name='button_box']" position="inside">
                    <button name="get_attachments" type="object"
                            class="oe_stat_button"
                            icon="fa-file-text-o">
                        <field name="attach_no" widget="statinfo" string="Documents"/>
                    </button>
                </xpath>

                <xpath expr="//div[@name='button_box']//button[@name='%(purchase_requisition.action_purchase_requisition_list)d']"
                       position="replace">
                    <button name="action_purchase_orders_view" type="object" class="oe_stat_button" icon="fa-list-alt"
                            attrs="{'invisible': [('state', '=', 'draft')]}">
                        <field name="order_count" widget="statinfo" string="RFQs/Orders"/>
                    </button>
                </xpath>
                <xpath expr="//field[@name='name']" position="after">
                    <field invisible="1" readonly="1" name='res_model'/>
                    <field invisible="1" readonly="1" name='res_id'/>
                </xpath>
                <!-- header modificaton -->
                <xpath expr="/form/header/button[@name='action_open']" position="after">
                    <button type="object" groups="purchase_requisition_custom.group_accept_purchase_requisition"
                            name="action_accept" string="Accept"
                            attrs="{'invisible':['|',('state','!=','in_progress'),('type','!=','project')]}"
                            class="oe_highlight"/>
                    <button type="object" groups="purchase_requisition_custom.group_quotation_purchase_requisition"
                            name="action_quotation" string="Quotation"
                            attrs="{'invisible':['&amp;','|',('state','!=','accept'),('type','!=','project'),'|',('state','not in',('in_progress', 'ongoing')),('type','!=','operational')]}"
                            class="btn-primary"/>
<!--                    <button type="object" groups="purchase.group_purchase_user" name="action_budget"-->
<!--                            string="Send To Budget" states="purchase_manager" class="btn-primary"/>-->
<!--                    <button name="action_skip_purchase_budget" type="object" string="Skip Budget"-->
<!--                            attrs="{'invisible':['|', ('state','!=', 'purchase_manager'),('is_purchase_budget','=',False)]}"-->
<!--                            groups="purchase_requisition_custom.group_skip_purchase_budget"/>-->

                    <button type="object" groups="purchase_requisition_custom.group_approve_purchase_requisition"
                            name="action_approve" string="Approve" states="purchase_manager" class="btn-primary"/>

                    <button type="object" groups="purchase_requisition_custom.purchase_requisition_second_approve"
                            name="second_approval" string="Approve" states="second_approve" class="btn-primary"/>
                    <button type="object" groups="purchase_requisition_custom.purchase_requisition_third_approve"
                            name="third_approve" string="Approve" states="third_approve" class="btn-primary"/>

                    <button name="to_committee" class="oe_highlight"
                            attrs="{'invisible' : ['|','|',('order_count','=', 0),('purchase_commitee','=',False),'&amp;',('purchase_commitee','=',True),('sent_to_commitee','=', True)]}"
                            type="object" string="Send To Committee"
                            groups="purchase_requisition_custom.purchase_rfq_send_to_committee"/>

                    <field name="sent_to_commitee" invisible="1"/>

                </xpath>
                <xpath expr="//field[@name='line_ids']/tree[1]/field[@name='product_qty']" position="before">
                    <field name="department_id" attrs="{'column_invisible': [('parent.purchase_cost', '=', 'default')],
                            'readonly': ['|', ('parent.state', '=', 'accept'), ('parent.order_count', '>', 0)]}"/>
                </xpath>

                <xpath expr="/form/header/button[@name='action_done']" position="replace">
                    <button type="object" name="action_done"
                            groups="purchase_requisition_custom.group_done_purchase_requisition" string="Done"
                            states="open,ongoing" class="btn-primary"/>
                </xpath>
                <xpath expr="/form/header/button[@type='action'][1]" position="attributes">
                    <attribute name="invisible">1</attribute>
                </xpath>
                <xpath expr="//field[@name='name']" position="attributes">
                    <attribute name="readonly">1</attribute>
                </xpath>
                <xpath expr="//field[@name='user_id']" position="attributes">
                    <attribute name="readonly">1</attribute>
                </xpath>

                <xpath expr="//field[@name='type_id']" position="replace">
                    <field name="type_id" attrs="{
                'readonly': [('state','not in',('draft'))]}" required="1" widget="selection"/>
                </xpath>

                <xpath expr="/form/header/button[@name='action_in_progress']" position="replace">
                    <button name="action_in_progress"
                            groups="purchase_requisition_custom.group_confirm_purchase_requisition" states="draft"
                            string="Confirm" type="object" class="btn-primary"/>
                </xpath>
                <xpath expr="/form/header/button[@name='action_cancel']" position="replace">
                    <button name="action_cancel" groups="purchase_requisition_custom.group_cancel_purchase_requisition"
                            states="draft,in_progress,ongoing" string="Cancel" type="object"/>
                </xpath>
                <xpath expr="/form/header/button[@name='action_draft']" position="attributes">
                    <attribute name="attrs">{'invisible':[('state','!=','cancel')]}</attribute>
                </xpath>
                <xpath expr="/form/header/button[@name='action_open']" position="attributes">
                    <attribute name="invisible">1</attribute>
                </xpath>
                <xpath expr="/form/header/button[@type='action'][2]" position="attributes">
                    <attribute name="invisible">1</attribute>
                </xpath>
                <xpath expr="/form/header/field[@name='state']" position="replace">
                    <field name="state" widget="statusbar" statusbar_visible="draft,in_progress,done"
                           attrs="{'invisible': [('is_quantity_copy', '=', 'none')]}"/>
                </xpath>
                <xpath expr="//field[@name='user_id']" position="after">
                    <field name="check_request" invisible="1"/>
                    <field name="category_ids" required="1"
                           attrs="{'readonly':['|',('state','in',('cancel','checked','done','waiting')),('check_request','=',True)]}"
                           widget="many2many_tags"/>

                    <field name="purchase_cost" required="1"
                           attrs="{'readonly':[('state','in',('cancel','checked','done','waiting'))]}"/>

                    <field name="department_id" attrs="{'required':[('purchase_cost','=', 'department')], 'invisible':[('purchase_cost','=', 'product_line')],
                           'readonly':['|',('state','in',('cancel','checked','done','waiting')),('check_request','=',True)]}"/>
                    <field name="purpose" required="1"
                           attrs="{'readonly':['|',('state','in',('cancel','checked','done','waiting')),('check_request','=',True)]}"/>

                    <field name="type" required="1"
                           attrs="{'readonly':[('state','in',('cancel','checked','done','waiting'))]}"/>
                    <field name="project_id"
                           attrs="{'invisible':[('type','!=', 'project')], 'required':[('type','=', 'project')], 'readonly':[('state' , '!=' , 'draft')]}"/>

                    <field name="request_id" readonly="1"/>
                    <field name="type_exclusive" invisible="1"/>
                </xpath>
                <xpath expr="//field[@name='vendor_id']" position="attributes">
                    <attribute name="attrs">{
                        'readonly': [('state','in',('cancel','checked','done','waiting'))],
                        'required': [('type_exclusive', '=', 'multiple')]
                        }
                    </attribute>
                </xpath>
                <xpath expr="//field[@name='ordering_date']" position="attributes">
                    <attribute name="required">1</attribute>
                </xpath>
                <xpath expr="//notebook/page[1]/field[@name='line_ids']/tree[1]/field[@name='product_id']"
                       position="replace">
                    <field name="product_id" context="{'product_id':parent.line_ids}"
                           domain="[('purchase_ok', '=', True),('categ_id','in',parent.category_ids)]"/>
                </xpath>
                <xpath expr="//notebook/page[1]/field[@name='line_ids']/tree[1]/field[@name='account_analytic_id']"
                       position="replace">
                    <field name="account_analytic_id"
                           attrs="{'column_invisible':[('parent.is_purchase_budget','=',False)]}"
                           domain="['|', ('company_id', '=', False), ('company_id', '=', parent.company_id)]"
                           groups="analytic.group_analytic_accounting"/>
                </xpath>
                <xpath expr="//notebook/page[1]/field[@name='line_ids']/tree[1]/field[@name='account_analytic_id']"
                       position="after">
                    <field name="name"/>
                </xpath>

                <xpath expr="//notebook/page[1]/field[@name='line_ids']" position="attributes">
                    <attribute name="attrs">
                        {'readonly':['|',('category_ids','=',False),('state','in',('cancel','done','waiting','checked'))]}
                    </attribute>
                </xpath>
                <xpath expr="//field[@name='company_id']" position="after">
                    <field name="is_purchase_budget" invisible="1"/>
                    <field name="purchase_commitee"/>
                    <field name="committee_type_id" attrs="{'invisible' : [('purchase_commitee' , '!=' , True)]}"
                           domain="[('type_cat', '=', category_ids)]"/>
                    <field name="committe_head"
                           attrs="{'invisible' : [('purchase_commitee' , '!=' , True)], 'required' : [('purchase_commitee' , '=' , True)]}"/>


                    <field name="min_approve"
                           attrs="{'invisible' : [('purchase_commitee' , '!=' , True)] , 'required' : [('purchase_commitee' , '=' , True)]}"/>
                    <field name="min_vote"
                           attrs="{'invisible' : [('purchase_commitee' , '!=' , True)] , 'required' : [('purchase_commitee' , '=' , True)]}"/>
                </xpath>
                <xpath expr="//page[last()]" position="after">
                    <page string="Purchase Committe Members"
                          attrs="{'invisible' : [('purchase_commitee' , '!=' , True)], 'required': [('purchase_commitee' , '=' , True)]}">
                        <field name="committe_members" attrs="{'required': [('purchase_commitee' , '=' , True)]}">
                            <tree>
                                <field name="name"/>
                            </tree>
                        </field>
                    </page>
                </xpath>
                <xpath expr="//field[@name='company_id']" position="after">
                    <field name="department_id" invisible="1"/>
                    <field name="days_count" invisible="1"/>
                </xpath>


            </field>
        </record>

        <!-- Purchase Requisition tree modifications -->
        <record id="purchase_requisition_custom_tree_view" model="ir.ui.view">
            <field name="name">purchase.requisition.tree.custom</field>
            <field name="model">purchase.requisition</field>
            <field name="inherit_id" ref="purchase_requisition.view_purchase_requisition_tree"/>
            <field name="arch" type="xml">
                <xpath expr="//tree" position="replace">
                    <!-- show edit button -->
                    <tree>
                        <field name="name"/>
                        <field name="ordering_date"/>
                        <field name="department_id"/>
                        <field name="category_ids" widget="many2many_tags"/>
                        <field name="state"/>
                    </tree>
                </xpath>
            </field>
        </record>

        <!-- Show Products menu -->
        <record model="ir.ui.menu" id="purchase.menu_purchase_products">
            <field name="groups_id"
                   eval="[(4,ref('purchase.group_purchase_manager')), (4,ref('purchase.group_purchase_user'))]"/>
        </record>

        <!-- adding group category manager to inventory and purchase menus -->
        <record model='ir.ui.menu' id='purchase.menu_product_category_config_purchase'>
            <field name="groups_id" eval="[(4,ref('purchase_requisition_custom.group_category_product_manager'))]"/>
        </record>
        <record model='ir.ui.menu' id='stock.menu_product_category_config_stock'>
            <field name="groups_id" eval="[(4,ref('purchase_requisition_custom.group_category_product_manager'))]"/>
        </record>

        <!-- add configuration to purchase manager -->
        <record model='ir.ui.menu' id='purchase.menu_purchase_config'>
            <field name="groups_id" eval="[(4,ref('purchase.group_purchase_manager'))]"/>
        </record>
        <record model='ir.ui.menu' id='purchase_requisition.menu_purchase_requisition_type'>
            <field name="groups_id" eval="[(4,ref('purchase.group_purchase_manager'))]"/>
        </record>
        <record model='ir.ui.menu' id='purchase.menu_product_in_config_purchase'>
            <field name="groups_id" eval="[(4,ref('purchase.group_purchase_manager'))]"/>
        </record>
        <record model='ir.ui.menu' id='purchase.menu_product_category_config_purchase'>
            <field name="groups_id" eval="[(4,ref('purchase.group_purchase_manager'))]"/>
        </record>
        <record model='ir.ui.menu' id='purchase.menu_purchase_uom_form_action'>
            <field name="groups_id" eval="[(4,ref('purchase.group_purchase_manager'))]"/>
        </record>

        <record id="reject_wizard_view" model="ir.ui.view">
            <field name="name">reject.wizard.wizard.view</field>
            <field name="model">reject.wizard</field>
            <field name="type">form</field>
            <field name="arch" type="xml">
                <form>
                    <field name="origin" invisible="1"/>
                    <field name="reject_reason" required="1"/>
                    <footer>
                        <button name="action_reject" string="Confirm" type="object" class="oe_highlight"/>
                        <button string="Cancel" class="btn btn-default" special="cancel"/>
                    </footer>
                </form>
            </field>
        </record>
        <record id="select_wizard_view" model="ir.ui.view">
            <field name="name">select.reason.wizard.view</field>
            <field name="model">select.reason</field>
            <field name="type">form</field>
            <field name="arch" type="xml">
                <form>
                    <field name="order_id" invisible="1"/>
                    <field name="select_reason" required="1"/>
                    <footer>
                        <button name="action_select" string="Confirm" type="object" class="oe_highlight"/>
                        <button string="Cancel" class="btn btn-default" special="cancel"/>
                    </footer>
                </form>
            </field>
        </record>


        <record id="order_select_wizard" model="ir.ui.view">
            <field name="name">refuse.reason.wizard.view</field>
            <field name="model">refuse.reason</field>
            <field name="type">form</field>
            <field name="arch" type="xml">
                <form>
                    <field name="order_id" invisible="1"/>
                    <field name="refuse_reason" required="1"/>
                    <footer>
                        <button name="action_refuse" string="Confirm" type="object" class="oe_highlight"/>
                        <button string="Cancel" class="btn btn-default" special="cancel"/>
                    </footer>
                </form>
            </field>
        </record>

        <record id="action_purchase_committe" model="ir.actions.act_window">
            <field name="name">Purchase Committee</field>
            <field name="res_model">purchase.requisition</field>
            <field name="view_mode">search,tree,form</field>
            <field name="domain">[('state' , '=' , 'committee')]</field>
            <field name="context">{'create':False,'edit':False, 'delete': False, 'duplicate':False,
                'from_committee_action': True}
            </field>
            <field name="groups_id" eval="[(4, ref('purchase_requisition_custom.committe_member'))]"/>
        </record>
        <!-- add domain toaction supplier form -->
        <record id="base.action_partner_supplier_form" model="ir.actions.act_window">
            <field name="name">Vendors</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">res.partner</field>

            <field name="domain">[]</field>
            <field name="view_mode">kanban,tree,form</field>
            <field name="context">{'search_default_supplier': 1,'default_customer': 0,'default_supplier': 1,
                'default_company_type': 'company'}
            </field>
            <field name="filter" eval="True"/>
            <field name="help" type="html">
                <p class="oe_view_nocontent_create">
                    Click to add a contact in your address book.
                </p>
                <p>
                    Odoo helps you easily track all activities related to
                    a supplier: discussions, history of purchases,
                    documents, etc.
                </p>
            </field>
        </record>

        <menuitem id="menu_purchase_committe_main" name="Purchase Committes" parent="purchase.menu_purchase_root"
                  sequence="18" groups="committe_member"/>
        <menuitem id="menu_purchase_committe" name="Purchase Committes" action="action_purchase_committe"
                  parent="menu_purchase_committe_main" sequence="1" groups="committe_member"/>
        <menuitem id="purchase.menu_procurement_management"
                  groups="purchase.group_purchase_user,purchase.group_purchase_manager"
                  parent="purchase.menu_purchase_root" name="Purchase"/>
        <menuitem id="reports" name="Reports" parent="purchase.menu_purchase_root" sequence="99"
                  groups="purchase_requisition_custom.group_purchase_requsition_reports"/>
        <menuitem id="purchase.purchase_report" name="Reporting" parent="reports" sequence="1"
                  groups="purchase.group_purchase_manager" action="purchase.action_purchase_order_report_all"/>
        <menuitem id="purchase_pdf_reports" name="Pdf Reports" parent="reports" sequence="2"/>
        <!-- add committee on conf-->
        <menuitem id="purchase_committe_type_menu" name="Purchase Comittee Types" parent="purchase.menu_purchase_config"
                  action="committe_type_action" sequence="100"/>



    </data>
</odoo>
